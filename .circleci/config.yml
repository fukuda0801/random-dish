version: 2.1

orbs:
  heroku: circleci/heroku@2.0

jobs:
  build_and_test:
    docker:
      - image: cimg/ruby:3.0.2
      - image: mysql:8.0
        environment:
          MYSQL_USER: root
          MYSQL_PASSWORD: password
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: random_dish_test
      - image: selenium/standalone-chrome:latest
        environment:
          SELENIUM_HOST: selenium
          SELENIUM_PORT: 4444
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt-get update && sudo apt-get install -y nodejs libmysqlclient-dev
            gem install bundler -v 2.2.16
            bundle install --jobs=4 --retry=3
      - run:
          name: Setup database
          command: |
            bundle exec rake db:create RAILS_ENV=test
            bundle exec rake db:schema:load RAILS_ENV=test
      - run:
          name: Migrate database
          command: |
            bundle exec rake db:migrate RAILS_ENV=test
      - run:
          name: Run RuboCop
          command: bundle exec rubocop
      - run:
          name: Run RSpec tests
          command: bundle exec rspec
      - run:
          name: Setup Test Environment
          command: |
            # Set up anything else you need for your test environment
      - run:
          name: Run Tests with Selenium
          command: |
            # Execute tests that require Selenium here

  deploy_to_heroku:
    docker:
      - image: cimg/ruby:3.0.2
    steps:
      - checkout
      - heroku/install
      - run:
          name: Deploy to Heroku
          command: |
            heroku git:remote -a $HEROKU_APP_NAME
            git push heroku $CIRCLE_SHA1:refs/heads/main

workflows:
  version: 2.1
  build_deploy:
    jobs:
      - build_and_test
      - deploy_to_heroku:
          requires:
            - build_and_test
          filters:
            branches:
              only: main
